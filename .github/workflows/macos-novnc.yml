name: macOS Safari (Browser Only)

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Create admin user
        run: |
          sudo sysadminctl -addUser admin -password 12345678 -admin

      - name: Enable Screen Sharing (VNC)
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure \
            -access -on \
            -users admin \
            -privs -all \
            -restart -agent

          sudo launchctl kickstart -k system/com.apple.screensharing
          sleep 5

          echo "Checking VNC port 5900..."
          lsof -i :5900 || exit 1

      - name: Set VNC legacy password
        run: |
          printf "12345678\n12345678\n" | sudo \
          /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts \
            -setvnclegacy -vnclegacy yes \
            -setvncpw

      - name: Install dependencies
        run: |
          brew update
          brew install python cloudflared
          python3 -m pip install --user websockify
          git clone https://github.com/novnc/noVNC.git $HOME/novnc

      - name: Start noVNC server
        run: |
          export PATH="$HOME/Library/Python/3.*/bin:$PATH"

          nohup python3 -m websockify \
            --web $HOME/novnc \
            6080 localhost:5900 \
            > $HOME/novnc.log 2>&1 &

          sleep 5
          echo "Checking noVNC port 6080..."
          lsof -i :6080 || exit 1

      - name: Launch Safari (to wake GUI)
        run: |
          open -a Safari
          sleep 5

      - name: Expose via Cloudflare Tunnel (KEEP ALIVE)
        run: |
          cloudflared tunnel \
            --no-autoupdate \
            --url http://localhost:6080
