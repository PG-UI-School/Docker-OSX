name: macOS Safari (Browser Only)

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Create admin user for VNC
        run: |
          sudo sysadminctl -addUser admin \
            -password 12345678 \
            -admin

      - name: Enable Screen Sharing (VNC)
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -users admin \
            -restart -agent \
            -privs -all

      - name: Set VNC Legacy Password
        run: |
          printf "12345678\n12345678\n" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts \
            -setvnclegacy -vnclegacy yes \
            -setvncpw

      - name: Install noVNC + websockify
        run: |
          brew install pipx
          pipx ensurepath
          pipx install websockify
          git clone https://github.com/novnc/noVNC.git ~/novnc

      - name: Start noVNC
        run: |
          nohup ~/.local/bin/websockify \
            --web ~/novnc \
            6080 localhost:5900 \
            > novnc.log 2>&1 &

      - name: Install Cloudflare Tunnel
        run: |
          brew install cloudflared

      - name: Expose via Cloudflare Quick Tunnel
        run: |
          cloudflared tunnel --url http://localhost:6080
