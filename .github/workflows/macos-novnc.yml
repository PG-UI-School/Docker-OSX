name: macOS Safari via noVNC

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Enable Screen Sharing
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -restart -agent -privs -all

      - name: Set VNC Password
        run: |
          printf "password\npassword\n" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -setvncpw

      - name: Install websockify
        run: |
          brew update
          brew install websockify

      - name: Install noVNC (manual, because Brew is unreliable)
        run: |
          git clone https://github.com/novnc/noVNC.git ~/novnc

      - name: Start noVNC Server
        run: |
          websockify --web ~/novnc 6080 localhost:5900 &

      - name: Show Access Info
        run: |
          echo "===================================="
          echo "OPEN THIS IN EDGE:"
          echo "https://github.com/${{ github.repository }}/actions"
          echo "Open the running job â†’ Logs"
          echo "noVNC is running on port 6080"
          echo "VNC password: password"
          echo "===================================="

      - name: Keep Alive
        run: sleep 6h
